<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CONSTRUCABLE - LOGISTICS PRO V28</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --claro-red: #ee2e24;
            --led-color: 0 0 20px rgba(238, 46, 36, 0.9);
            --led-green: 0 0 20px rgba(0, 255, 100, 0.9);
            --bg-dark: #050505;
        }

        #notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        .toast {
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            padding: 15px 25px;
            border-left: 5px solid var(--claro-red);
            margin-bottom: 10px;
            border-radius: 4px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            font-family: 'Rajdhani', sans-serif;
            font-weight: bold;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        .color-picker-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--claro-red);
            border: none;
            cursor: pointer;
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: var(--led-color);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Rajdhani', sans-serif; }
        body, html { height: 100%; background-color: var(--bg-dark); color: #fff; overflow-x: hidden; }
        
        #bg-canvas { position: fixed; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%); overflow: hidden; }
        .emoji { position: absolute; font-size: 6rem; opacity: 0.15; pointer-events: none; animation: float linear infinite; }
        @keyframes float { from { transform: translateY(110vh) rotate(0deg); } to { transform: translateY(-30vh) rotate(360deg); } }

        #page-login { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; z-index: 2000; background: var(--bg-dark); }
        .login-box { background: rgba(10,10,10,0.95); padding: 40px; border: 2px solid var(--claro-red); box-shadow: var(--led-color); width: 380px; text-align: center; border-radius: 12px; }

        #page-menu { display: none; min-height: 100vh; width: 100%; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .menu-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; width: 95%; max-width: 1100px; }
        .menu-card { background: rgba(20, 20, 20, 0.9); border: 2px solid #333; padding: 40px 15px; border-radius: 20px; text-align: center; cursor: pointer; transition: 0.4s; }
        .menu-card:hover { border-color: var(--claro-red); box-shadow: var(--led-color); transform: scale(1.05); }
        .menu-card.blue:hover { border-color: #00c3ff; box-shadow: 0 0 20px rgba(0, 195, 255, 0.8); }
        .menu-card.yellow:hover { border-color: #ffcc00; box-shadow: 0 0 20px rgba(255, 204, 0, 0.8); }

        #page-dash { display: none; flex-direction: column; min-height: 100vh; background: var(--bg-dark); }
        header { padding: 15px 25px; border-bottom: 2px solid var(--claro-red); background: #000; display: flex; justify-content: space-between; align-items: center; }
        
        .nav-tabs { display: flex; background: #0a0a0a; border-bottom: 1px solid #222; overflow-x: auto; }
        .tab-btn { padding: 18px 25px; background: transparent; border: none; color: #666; cursor: pointer; text-transform: uppercase; font-weight: bold; border-bottom: 4px solid transparent; }
        .tab-btn.active { color: #fff; border-bottom-color: var(--claro-red); text-shadow: var(--led-color); }

        .tab-content { display: none; padding: 25px; animation: fadeIn 0.4s; }
        .tab-content.active { display: block; }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .panel { background: rgba(15, 15, 15, 0.95); border: 1px solid #333; padding: 25px; border-radius: 10px; margin-bottom: 20px; }
        
        .summary-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; border: 1px solid #333; }
        .summary-table th { background: #111; color: var(--claro-red); padding: 12px; text-align: left; }
        .summary-table td { padding: 12px; border: 1px solid #333; font-weight: bold; }

        button { padding: 14px; cursor: pointer; border-radius: 6px; font-weight: bold; text-transform: uppercase; transition: 0.3s; width: 100%; border: 2px solid transparent; }
        .btn-green { border-color: #00ff64; color: #00ff64; background: transparent; }
        .btn-green:hover { background: #00ff64; color: #000; }
        .btn-red { border-color: var(--claro-red); color: var(--claro-red); background: transparent; }
        .btn-red:hover { background: var(--claro-red); color: #fff; }
        .btn-blue { border-color: #00c3ff; color: #00c3ff; background: transparent; }
        .btn-blue:hover { background: #00c3ff; color: #000; }
        .btn-yellow { border-color: #ffcc00; color: #ffcc00; background: transparent; }
        .btn-yellow:hover { background: #ffcc00; color: #000; }

        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; background: #000; border: 1px solid #333; color: #fff; border-radius: 4px; }
        .list-box { height: 350px; overflow-y: auto; background: rgba(0,0,0,0.6); padding: 10px; border: 1px solid #222; }
        .item-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #1a1a1a; align-items: center; }
        .item-row.checked { background: rgba(0, 255, 100, 0.25); border: 1px solid #00ff64; box-shadow: inset 0 0 15px rgba(0, 255, 100, 0.2); }
        .btn-del { width: auto; padding: 5px 10px; color: #555; background: none; border: none; cursor: pointer; font-size: 1.2rem; }
        .btn-del:hover { color: var(--claro-red); }

        .stat-card { background: #111; padding: 15px; border-radius: 8px; border-left: 4px solid var(--claro-red); text-align: center; }
        
        .status-badge { display: inline-flex; align-items: center; gap: 10px; padding: 10px 20px; border-radius: 30px; font-weight: bold; font-family: Orbitron; }
        .status-red { background: rgba(238, 46, 36, 0.2); color: #ee2e24; border: 1px solid #ee2e24; box-shadow: var(--led-color); }
        .status-green { background: rgba(0, 255, 100, 0.2); color: #00ff64; border: 1px solid #00ff64; box-shadow: var(--led-green); }

        .date-group { background: #111; padding: 10px; margin-top: 15px; border-left: 3px solid var(--claro-red); color: var(--claro-red); font-weight: bold; }

        .signature-pad { background: #fff; border: 2px solid var(--claro-red); border-radius: 8px; cursor: crosshair; touch-action: none; width: 100%; height: 150px; }
        #camera-preview { width: 100%; border-radius: 8px; display: none; margin-bottom: 10px; }
        #photo-canvas { display: none; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        #print-area { display: none; }
        @media print { 
            body * { visibility: hidden; } 
            #print-area { display: block !important; visibility: visible !important; position: absolute; left: 0; top: 0; width: 100%; color: #000 !important; background: #fff !important; }
            #print-area * { visibility: visible !important; }
        }
    </style>
</head>
<body>

<div id="notification-container"></div>
<button class="color-picker-btn" onclick="toggleTheme()" title="Mudar Cor do Sistema">üé®</button>

<div id="bg-canvas"></div>

<div id="page-login">
    <div class="login-box">
        <h1 style="font-family: Orbitron; color: var(--claro-red); font-size: 2rem;">CONSTRUCABLE</h1>
        <p style="letter-spacing: 5px; font-size: 0.7rem; margin-bottom: 25px; opacity: 0.7;">LOGISTICS PRO SYSTEM</p>
        <input type="text" id="user-input" placeholder="USU√ÅRIO">
        <input type="password" id="pass-input" placeholder="SENHA">
        <button class="btn-red" onclick="handleLogin()">ENTRAR</button>
        <p style="font-size: 0.6rem; margin-top: 15px; opacity: 0.5;">Dev by Jess√© Moura</p>
    </div>
</div>

<div id="page-menu">
    <h1 style="font-family: Orbitron; margin-bottom: 20px; text-shadow: var(--led-color);">MENU PRINCIPAL</h1>
    <p id="welcome-msg" style="margin-bottom: 30px; color: var(--claro-red); font-weight: bold;"></p>
    <div class="menu-grid">
        <div class="menu-card" onclick="openEstoque(); showTab(null, 'master')">
            <div style="font-size: 4rem;">üì¶</div>
            <span style="font-family: Orbitron;">ESTOQUE</span>
        </div>
        <div class="menu-card" onclick="openEstoque(); showTab(null, 'entrada-pendente')">
            <div style="font-size: 4rem;">üì•</div>
            <span style="font-family: Orbitron;">ENTRADA</span>
        </div>
        <div class="menu-card yellow" onclick="openEstoque(); showTab(null, 'cabos-tecnico')">
            <div style="font-size: 4rem;">‚û∞</div>
            <span style="font-family: Orbitron;">CABOS T√âCNICO</span>
        </div>
        <div class="menu-card blue" onclick="gerarBackupCompleto()">
            <div style="font-size: 4rem; color: #00c3ff;">üíæ</div>
            <span style="font-family: Orbitron; color: #00c3ff;">BACKUP EXCEL</span>
        </div>
    </div>
    <button class="btn-red" style="width: 200px; margin-top: 40px;" onclick="handleLogout()">SAIR / LOGOUT</button>
</div>

<div id="page-dash">
    <header>
        <h2 style="font-family: Orbitron;">CONSTRUCABLE <span style="color:var(--claro-red)">// <span id="op-name"></span></span></h2>
        <div style="display:flex; gap:15px;">
            <button class="btn-green" style="width:auto; padding:5px 20px" onclick="backToMenu()">VOLTAR AO MENU</button>
            <div id="clock" style="color:#fff; align-self:center; font-family:monospace; background:#111; padding:5px 10px; border:1px solid #333"></div>
        </div>
    </header>

    <nav class="nav-tabs">
        <button id="btn-tab-master" class="tab-btn active" onclick="showTab(event, 'master')">Estoque ADM</button>
        <button id="btn-tab-entrada" class="tab-btn" onclick="showTab(event, 'entrada-pendente')">Entrada</button>
        <button id="btn-tab-cabos" class="tab-btn" onclick="showTab(event, 'cabos-tecnico')">Cabos</button>
        <button class="tab-btn" onclick="showTab(event, 'transfer-tech')">Transfer√™ncia</button>
        <button class="tab-btn" onclick="showTab(event, 'carga')">Sa√≠da p/ T√©cnico</button>
        <button class="tab-btn" onclick="showTab(event, 'baixa')">Baixa Assinante</button>
        <button class="tab-btn" onclick="showTab(event, 'mala')">Mala / Confer√™ncia</button>
        <button class="tab-btn" onclick="showTab(event, 'busca')">Busca Serial</button>
        <button class="tab-btn" onclick="showTab(event, 'logs')">Hist√≥rico</button>
        <button class="tab-btn" onclick="showTab(event, 'users')">Gest√£o</button>
    </nav>

    <div id="cabos-tecnico" class="tab-content">
        <div class="panel">
            <h3 style="color: #ffcc00;">‚û∞ ENTREGA DE CABOS E MATERIAIS</h3>
            <div class="grid" style="grid-template-columns: 1.5fr 1fr;">
                <div>
                    <label>Selecione o T√©cnico:</label>
                    <select id="sel-tech-cabos"><option value="">Carregando t√©cnicos...</option></select>
                    <div style="display: flex; gap: 10px;">
                        <div style="flex: 2;">
                            <label>Tipo de Cabo:</label>
                            <select id="sel-tipo-cabo">
                                <option value="CABO BRANCO">CABO BRANCO</option>
                                <option value="CABO PRETO">CABO PRETO</option>
                                <option value="CABO DE FIBRA">CABO DE FIBRA</option>
                                <option value="CABO DE REDE">CABO DE REDE</option>
                            </select>
                        </div>
                        <div style="flex: 1;">
                            <label>Quantidade (M/Un):</label>
                            <input type="number" id="qtd-cabo" placeholder="Ex: 100" min="1">
                        </div>
                    </div>
                    <button class="btn-yellow" onclick="addCaboFila()">+ INCLUIR NA LISTA</button>
                    <div style="margin-top: 20px;">
                        <label>üì∏ Registro Fotogr√°fico:</label>
                        <video id="camera-preview" autoplay playsinline></video>
                        <canvas id="photo-canvas"></canvas>
                        <button id="btn-camera" class="btn-blue" onclick="toggleCamera()">ABRIR C√ÇMERA</button>
                        <button id="btn-take-photo" class="btn-green" style="display:none;" onclick="takePhoto()">CAPTURAR FOTO</button>
                        <p id="photo-status" style="font-size: 0.7rem; color: #00ff64; display: none;">‚úÖ FOTO REGISTRADA COM DATA/HORA</p>
                    </div>
                    <div style="margin-top: 20px;">
                        <label>‚úçÔ∏è Assinatura do T√©cnico:</label>
                        <canvas id="signature-pad" class="signature-pad"></canvas>
                        <button class="btn-del" onclick="clearSignature()" style="font-size: 0.7rem; margin-top: 5px;">LIMPAR ASSINATURA</button>
                    </div>
                </div>
                <div>
                    <h4>LISTA PARA ENTREGA</h4>
                    <div id="list-cabos-queue" class="list-box" style="height: 250px;"></div>
                    <button id="btn-save-cabos" class="btn-green" style="margin-top: 10px;" onclick="salvarCabos()">FINALIZAR E SALVAR</button>
                    <button id="btn-print-cabos" class="btn-red" style="margin-top: 10px; display:none;" onclick="imprimirReciboCabos()">üñ®Ô∏è IMPRIMIR COMPROVANTE</button>
                </div>
            </div>
        </div>
    </div>

    <div id="master" class="tab-content active">
        <div class="grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 20px;">
            <div class="stat-card"><h4>ADM</h4><p id="stat-adm">0</p></div>
            <div class="stat-card"><h4>T√âCNICOS</h4><p id="stat-tech">0</p></div>
            <div class="stat-card"><h4>TOTAL</h4><p id="stat-total">0</p></div>
        </div>
        <div class="grid">
            <div class="panel">
                <h3>üì• IMPORTAR / ADICIONAR</h3>
                <input type="file" id="file-upload" accept=".xlsx, .xls">
                <div style="display: flex; gap:5px;">
                    <input type="text" id="man-sn" placeholder="N√∫mero S√©rie">
                    <input type="text" id="man-mod" placeholder="Modelo">
                </div>
                <button class="btn-green" onclick="addManual()">ADICIONAR MANUAL</button>
                <button class="btn-red" style="margin-top:15px;" onclick="clearOnlyADM()">‚ö†Ô∏è LIMPAR APENAS ESTOQUE ADM</button>
            </div>
            <div class="panel">
                <h3>üë• CADASTRAR NOVO T√âCNICO</h3>
                <div style="display: flex; gap:5px;">
                   <input type="text" id="tech-name" placeholder="Nome Completo">
                   <input type="text" id="tech-login" placeholder="Login/Matr√≠cula">
                </div>
                <button class="btn-green" onclick="addTech()">CADASTRAR T√âCNICO</button>
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px; margin-top:10px">
                    <button class="btn-blue" style="font-size: 0.7rem;" onclick="exportExcelADM()">üìä EXCEL ADM</button>
                    <button class="btn-blue" style="font-size: 0.7rem;" onclick="exportExcelTechs()">üìä EXCEL TECS</button>
                    <button class="btn-blue" style="font-size: 0.7rem;" onclick="exportExcelLogs()">üìä EXCEL HIST</button>
                </div>
            </div>
        </div>
        <div class="panel">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3>üì¶ RESUMO POR FAM√çLIA</h3>
                <input type="text" id="search-adm-list" placeholder="üîç Procurar serial..." oninput="renderMaster()" style="width: 300px; margin: 0;">
            </div>
            <table class="summary-table">
                <thead><tr><th>FAM√çLIA (MODELO)</th><th>ADM</th><th>TECS</th><th>TOTAL</th></tr></thead>
                <tbody id="sum-master"></tbody>
            </table>
            <div id="list-master" class="list-box"></div>
        </div>
    </div>

    <div id="entrada-pendente" class="tab-content">
        <div class="grid">
            <div class="panel">
                <h3>üì• CONFER√äNCIA DE ENTRADA</h3>
                <input type="text" id="bip-entrada" placeholder="BIPE O SERIAL √öNICO" onkeypress="handleBipeEntrada(event)" style="border: 2px solid var(--claro-red); font-size: 1.2rem;">
                <hr style="margin: 15px 0; border: 0; border-top: 1px solid #333;">
                <h3>üì• ENTRADA POR LOTE (S√âRIES)</h3>
                <input type="text" id="lote-modelo" placeholder="MODELO PARA O LOTE">
                <textarea id="lote-entrada-txt" rows="6" placeholder="COLE OS SERIAIS AQUI (UM POR LINHA)"></textarea>
                <button class="btn-green" onclick="processarEntradaLote()">INCLUIR LOTE NO ESTOQUE ADM</button>
            </div>
            <div class="panel">
                <h3>üì• PENDENTES DE IMPORTA√á√ÉO</h3>
                <div id="list-pendentes" class="list-box" style="height: 400px;"></div>
                <button class="btn-red" style="margin-top:10px" onclick="limparPendentesGeral()">LIMPAR TUDO PENDENTE</button>
            </div>
        </div>
    </div>

    <div id="mala" class="tab-content">
        <div class="panel">
            <h3>üéí CONFER√äNCIA F√çSICA</h3>
            <div class="grid" style="grid-template-columns: 2fr 1fr;">
                <select id="sel-view-mala" onchange="renderMalaCompleta(this.value)"></select>
                <button class="btn-red" onclick="resetConferencia()">üîÑ RESETAR VERDES</button>
            </div>
            <div id="resumo-mala-container" style="margin-top:20px; display:none;">
                <div style="text-align: center; margin-bottom: 20px;"><div id="mala-status-sinalizador" class="status-badge"></div></div>
                <div class="grid">
                    <div class="panel">
                        <input type="text" id="bip-conferencia" placeholder="BIPE PARA CONFERIR" onkeypress="marcarConferido(event)" style="border: 2px solid #00ff64; font-size: 1.2rem;">
                        <div id="list-mala-items" class="list-box" style="margin-top:15px"></div>
                        <button class="btn-blue" style="margin-top:15px" onclick="imprimirConferencia()">üñ®Ô∏è GERAR COMPROVANTE DE CONFER√äNCIA</button>
                    </div>
                    <div class="panel">
                        <h4>üìä RESUMO NA MALA (POR FAM√çLIA)</h4>
                        <table class="summary-table" style="font-size: 0.8rem; margin-top: 10px;">
                            <thead><tr><th>FAM√çLIA</th><th>QUANTIDADE</th></tr></thead>
                            <tbody id="sum-mala-tecnico"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="carga" class="tab-content">
        <div class="panel">
            <div class="grid">
                <div>
                    <h3>‚ö° SA√çDA PARA T√âCNICO</h3>
                    <select id="sel-tech-carga"><option value="">Selecione o T√©cnico...</option></select>
                    <input type="text" id="bip-carga" placeholder="BIPE O SERIAL E ENTER" onkeypress="handleBipeCarga(event)">
                    <textarea id="lote-carga" rows="5" placeholder="Ou cole v√°rios seriais aqui..."></textarea>
                    <button class="btn-blue" onclick="addLoteCarga()">VALIDAR LOTE</button>
                    <button id="btn-confirm-carga" class="btn-green" style="margin-top:20px" onclick="confirmarCarga()">FINALIZAR SA√çDA</button>
                    <button id="btn-print" class="btn-red" style="display:none" onclick="imprimirComprovante()">üñ®Ô∏è IMPRIMIR RECIBO</button>
                </div>
                <div>
                    <h3>üìã FILA DE ESPERA <span id="queue-count" style="color:var(--claro-red);">(0)</span></h3>
                    <div id="list-queue" class="list-box"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="transfer-tech" class="tab-content">
        <div class="panel">
            <h3>üîÑ MOVIMENTA√á√ÉO ENTRE MALAS</h3>
            <div class="grid">
                <div><label>De (Origem):</label><select id="sel-tech-origem" onchange="renderMalaOrigem(this.value)"></select></div>
                <div><label>Para (Destino):</label><select id="sel-tech-destino"></select></div>
            </div>
            <div style="margin-top:15px; border:1px solid #444; padding:15px">
                <input type="text" id="bip-trans" placeholder="Bipe Serial..." onkeypress="addBipTrans(event)">
                <textarea id="lote-trans" rows="2" placeholder="Ou cole seriais..."></textarea>
                <button class="btn-blue" onclick="addLoteTrans()">INCLUIR NA FILA</button>
            </div>
            <div class="grid" style="margin-top:20px">
                <div class="panel"><h4>Mala Origem</h4><div id="list-mala-origem" class="list-box"></div></div>
                <div class="panel"><h4>Fila de Movimento <span id="trans-queue-count" style="color:var(--claro-red)">(0)</span></h4><div id="list-transfer-queue" class="list-box"></div></div>
            </div>
            <button class="btn-green" onclick="executarMovimentacao()">EXECUTAR TRANSFER√äNCIA DEFINITIVA</button>
        </div>
    </div>

    <div id="baixa" class="tab-content">
        <div class="panel">
            <h3>üìâ BAIXA POR ASSINANTE / RETIRADA POR LOTE</h3>
            <textarea id="txt-baixa" rows="10" placeholder="Cole os seriais para remover..."></textarea>
            <button class="btn-red" onclick="executarBaixa()">BAIXAR (REMOVER DO SISTEMA)</button>
        </div>
    </div>

    <div id="busca" class="tab-content">
        <div class="panel">
            <h3>üîç RASTREAR SERIAL</h3>
            <input type="text" placeholder="Digite e Enter" onkeypress="consultar(event)">
            <div id="search-result" style="text-align:center; margin-top:20px; color:var(--claro-red); font-size: 1.2rem;"></div>
        </div>
    </div>

    <div id="logs" class="tab-content">
        <div class="panel">
            <h3>üìú HIST√ìRICO GERAL</h3>
            <div id="list-logs" class="list-box" style="height:500px"></div>
        </div>
    </div>

    <div id="users" class="tab-content">
        <div class="panel">
            <h3>üîë GEST√ÉO DE ACESSOS E PESSOAL</h3>
            <div class="grid">
                <div>
                    <h4>ADICIONAR OPERADOR</h4>
                    <input type="text" id="new-user-name" placeholder="Nome do Operador">
                    <input type="password" id="new-user-pass" placeholder="Senha">
                    <button class="btn-green" onclick="addUser()">CADASTRAR OPERADOR</button>
                    <hr style="margin: 20px 0; border-color: #333;">
                    <h4>LISTA DE OPERADORES</h4>
                    <div id="list-users" class="list-box" style="height: 150px;"></div>
                </div>
                <div>
                    <h4>LISTA DE T√âCNICOS CADASTRADOS</h4>
                    <div id="list-techs-management" class="list-box" style="height: 400px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="print-area"></div>

<script>
    // SISTEMA DE TEMAS
    const themes = [
        { name: 'Red', main: '#ee2e24', led: '0 0 20px rgba(238, 46, 36, 0.9)' },
        { name: 'Blue', main: '#00c3ff', led: '0 0 20px rgba(0, 195, 255, 0.9)' },
        { name: 'Green', main: '#00ff64', led: '0 0 20px rgba(0, 255, 100, 0.9)' },
        { name: 'Purple', main: '#bc13fe', led: '0 0 20px rgba(188, 19, 254, 0.9)' }
    ];
    let currentThemeIdx = parseInt(localStorage.getItem('cc_theme')) || 0;

    function applyTheme() {
        const t = themes[currentThemeIdx];
        document.documentElement.style.setProperty('--claro-red', t.main);
        document.documentElement.style.setProperty('--led-color', t.led);
        localStorage.setItem('cc_theme', currentThemeIdx);
    }

    function toggleTheme() {
        currentThemeIdx = (currentThemeIdx + 1) % themes.length;
        applyTheme();
        notify(`Tema ${themes[currentThemeIdx].name} aplicado!`);
    }

    // NOTIFICA√á√ïES
    function notify(msg, type = 'success') {
        const container = document.getElementById('notification-container');
        if(!container) return;
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.style.borderLeftColor = type === 'success' ? 'var(--claro-red)' : '#ffcc00';
        toast.innerText = msg;
        container.appendChild(toast);
        setTimeout(() => { if(toast) toast.remove(); }, 3000);
    }

    // BANCO DE DADOS
    let db = JSON.parse(localStorage.getItem('cc_db_v28')) || { 
        master: [], 
        techs: [], 
        logs: [], 
        users: [{name: 'ADMIN', pass: 'admin'}],
        pendentes: [],
        cabosLogs: [],
        baixas: []
    };
    
    let currentUser = null;
    let queue = [];
    let cabosQueue = [];
    let transQueue = [];
    let lastCarga = null;
    let lastCargaCabos = null;
    let conferidos = new Set();
    let currentPhoto = null;

    applyTheme();

    function save() { localStorage.setItem('cc_db_v28', JSON.stringify(db)); }
    function now() { return new Date().toLocaleString('pt-BR'); }

    // LOGIN
    function handleLogin() {
        const u = document.getElementById('user-input').value.trim().toUpperCase();
        const p = document.getElementById('pass-input').value;
        const found = db.users.find(x => x.name === u && x.pass === p);
        if(found) {
            currentUser = found.name;
            document.getElementById('page-login').style.display = 'none';
            document.getElementById('page-menu').style.display = 'flex';
            document.getElementById('welcome-msg').innerText = `BEM-VINDO, ${currentUser}`;
            document.getElementById('op-name').innerText = currentUser;
            initEmojis();
            notify(`Acesso autorizado: ${currentUser}`);
        } else { notify("Usu√°rio ou Senha incorretos!", "error"); }
    }
    
    function handleLogout() { location.reload(); }
    function backToMenu() { document.getElementById('page-dash').style.display = 'none'; document.getElementById('page-menu').style.display = 'flex'; }
    function openEstoque() { document.getElementById('page-menu').style.display = 'none'; document.getElementById('page-dash').style.display = 'flex'; updateAll(); }
    
    // NAVEGA√á√ÉO
    function showTab(e, id) { 
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active')); 
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); 
        document.getElementById(id).classList.add('active'); 
        if(e) e.currentTarget.classList.add('active'); 
        else {
            const btnMap = { 'master': 'btn-tab-master', 'entrada-pendente': 'btn-tab-entrada', 'cabos-tecnico': 'btn-tab-cabos' };
            if(btnMap[id]) document.getElementById(btnMap[id]).classList.add('active');
        }
        if(id === 'entrada-pendente') renderPendentes();
        if(id === 'cabos-tecnico') initSignaturePad();
        if(id === 'users') renderUsersLists();
    }

    // ASSINATURA CABOS
    function initSignaturePad() {
        const canvas = document.getElementById('signature-pad');
        if(!canvas) return;
        const ctx = canvas.getContext('2d');
        let writing = false;
        const getPos = (e) => {
            const rect = canvas.getBoundingClientRect();
            return {
                x: (e.clientX || (e.touches ? e.touches[0].clientX : 0)) - rect.left,
                y: (e.clientY || (e.touches ? e.touches[0].clientY : 0)) - rect.top
            };
        };
        const start = (e) => { writing = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); };
        const move = (e) => { if(!writing) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); e.preventDefault(); };
        const end = () => writing = false;
        canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', move); window.addEventListener('mouseup', end);
        canvas.addEventListener('touchstart', start); canvas.addEventListener('touchmove', move); canvas.addEventListener('touchend', end);
        ctx.strokeStyle = "#000"; ctx.lineWidth = 2;
    }

    function clearSignature() {
        const canvas = document.getElementById('signature-pad');
        if(canvas) canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
    }

    // C√ÇMERA
    async function toggleCamera() {
        const video = document.getElementById('camera-preview');
        if(video.style.display === 'none' || !video.style.display) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream;
                video.style.display = 'block';
                document.getElementById('btn-take-photo').style.display = 'block';
                document.getElementById('btn-camera').innerText = "FECHAR C√ÇMERA";
            } catch (err) { notify("Erro ao acessar c√¢mera!", "error"); }
        } else {
            if(video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
            video.style.display = 'none';
            document.getElementById('btn-take-photo').style.display = 'none';
            document.getElementById('btn-camera').innerText = "ABRIR C√ÇMERA";
        }
    }

    function takePhoto() {
        const video = document.getElementById('camera-preview');
        const canvas = document.getElementById('photo-canvas');
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);
        ctx.font = "20px Arial";
        ctx.fillStyle = "red";
        ctx.fillText(`CONSTRUCABLE - ${now()}`, 20, 40);
        currentPhoto = canvas.toDataURL('image/jpeg');
        document.getElementById('photo-status').style.display = 'block';
        notify("Foto capturada!");
        toggleCamera();
    }

    // GEST√ÉO DE CABOS
    function addCaboFila() {
        const tipo = document.getElementById('sel-tipo-cabo').value;
        const qtd = document.getElementById('qtd-cabo').value;
        if(!qtd || qtd <= 0) return notify("Quantidade inv√°lida!", "error");
        cabosQueue.push({ tipo, qtd, data: now(), operador: currentUser });
        renderCabosQueue();
        document.getElementById('qtd-cabo').value = '';
    }

    function renderCabosQueue() {
        const list = document.getElementById('list-cabos-queue');
        list.innerHTML = cabosQueue.map((item, idx) => `
            <div class="item-row">
                <div style="display:flex; flex-direction:column;">
                    <span><b>${item.tipo}</b> - ${item.qtd}m</span>
                    <small style="opacity:0.7; font-size:0.7rem;">${item.data} | OP: ${item.operador}</small>
                </div>
                <button class="btn-del" onclick="cabosQueue.splice(${idx}, 1); renderCabosQueue();">‚úñ</button>
            </div>
        `).join('');
    }

    function salvarCabos() {
        const tIdx = document.getElementById('sel-tech-cabos').value;
        if(tIdx === '' || cabosQueue.length === 0) return notify("Selecione t√©cnico e itens!", "error");
        const sigCanvas = document.getElementById('signature-pad');
        const signatureData = sigCanvas.toDataURL();
        const tec = db.techs[tIdx];
        const h = now();
        if(!db.cabosLogs) db.cabosLogs = [];
        const logEntry = { techName: tec.name, techLogin: tec.login, items: [...cabosQueue], date: h, op: currentUser, photo: currentPhoto, signature: signatureData };
        db.cabosLogs.unshift(logEntry);
        db.logs.unshift({ tech: tec.name, items: cabosQueue.map(c => ({ serial: 'CABO', modelo: c.tipo })), date: h, type: 'CABOS', op: currentUser });
        lastCargaCabos = logEntry;
        cabosQueue = []; currentPhoto = null;
        document.getElementById('photo-status').style.display = 'none';
        clearSignature(); renderCabosQueue(); save();
        notify("Carga de cabos salva!");
        document.getElementById('btn-save-cabos').style.display = 'none';
        document.getElementById('btn-print-cabos').style.display = 'block';
    }

    function imprimirReciboCabos() {
        const html = `
            <div style="color:#000; padding:30px; font-family: sans-serif; width: 100%;">
                <h1 style="text-align:center; font-size: 20px; border-bottom: 3px solid #000; padding-bottom: 10px;">RECIBO DE MATERIAIS / CABOS</h1>
                <div style="display: flex; justify-content: space-between;">
                    <div style="font-size: 13px;">
                        <p><b>T√âCNICO:</b> ${lastCargaCabos.techName}</p>
                        <p><b>MATR√çCULA:</b> ${lastCargaCabos.techLogin}</p>
                        <p><b>DATA/HORA:</b> ${lastCargaCabos.date}</p>
                        <p><b>OPERADOR:</b> ${lastCargaCabos.op}</p>
                    </div>
                    ${lastCargaCabos.photo ? `<img src="${lastCargaCabos.photo}" style="width:150px; border:1px solid #000;">` : ''}
                </div>
                <table style="width: 100%; border-collapse: collapse; margin-top:20px;">
                    <thead><tr style="border-bottom: 2px solid #000; background:#f2f2f2;"><th style="text-align:left; padding:8px;">DESCRI√á√ÉO</th><th style="text-align:right; padding:8px;">QUANTIDADE</th></tr></thead>
                    <tbody>${lastCargaCabos.items.map(i => `<tr style="border-bottom:1px solid #ddd;"><td style="padding:8px;">${i.tipo}</td><td style="padding:8px; text-align:right;">${i.qtd} m</td></tr>`).join('')}</tbody>
                </table>
                <p style="background: #f9f9f9; padding: 10px; border: 1px dashed #000; font-weight: bold; margin-top:20px; font-size:12px;">
                    ‚ö†Ô∏è AVISO DE CONTROLE: Tenha o m√°ximo cuidado com os cabos retirados. Mantenha sempre o controle rigoroso da metragem utilizada e o lan√ßamento correto no sistema para evitar diverg√™ncias em seu estoque.
                </p>
                <div style="margin-top: 30px;">
                    <p style="font-size: 12px;"><b>ASSINATURA DIGITAL:</b></p>
                    <img src="${lastCargaCabos.signature}" style="width:300px; border-bottom: 1px solid #000;">
                </div>
            </div>`;
        document.getElementById('print-area').innerHTML = html; window.print();
        document.getElementById('btn-print-cabos').style.display = 'none';
        document.getElementById('btn-save-cabos').style.display = 'block';
    }

    // COMPROVANTE DE SA√çDA CARGA
    function imprimirComprovante() {
        if(!lastCarga) return;
        const html = `
            <div style="color:#000; padding:40px; font-family: sans-serif; max-width: 800px; margin: auto; border: 1px solid #ddd;">
                <div style="text-align:center; border-bottom: 4px solid #000; padding-bottom:10px; margin-bottom: 20px;">
                    <h1 style="margin:0; font-size: 22px;">‚ö° COMPROVANTE DE SA√çDA DE ESTOQUE</h1>
                    <p style="text-transform: uppercase; font-weight: bold; margin: 5px 0;">CONSTRUCABLE LOG√çSTICA</p>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; margin-bottom: 20px; background: #f5f5f5; padding: 15px; border-radius: 5px;">
                    <div>
                        <p><b>T√âCNICO:</b> ${lastCarga.tech}</p>
                        <p><b>MATR√çCULA:</b> ${lastCarga.login}</p>
                    </div>
                    <div style="text-align: right;">
                        <p><b>DATA:</b> ${lastCarga.date}</p>
                        <p><b>OPERADOR:</b> ${lastCarga.op}</p>
                    </div>
                </div>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #000; color: #fff;">
                            <th style="padding: 10px; border: 1px solid #333; text-align: left;">DESCRI√á√ÉO DO ATIVO / MODELO</th>
                            <th style="padding: 10px; border: 1px solid #333; text-align: left;">N√öMERO DE S√âRIE (SN)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${lastCarga.items.map(i => `
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;">${i.modelo}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; font-family: monospace; font-weight: bold;">${i.serial}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <div style="margin-top: 25px; padding: 15px; border: 1px dashed #000; background: #fffcf0; font-size: 13px; line-height: 1.5;">
                    <p><b>üìú TERMO DE RESPONSABILIDADE:</b></p>
                    <p>O t√©cnico acima identificado declara ter recebido os equipamentos em perfeito estado de conserva√ß√£o. O prazo para presta√ß√£o de contas (baixa em assinante) ou devolu√ß√£o f√≠sica ao estoque ADM √© de <b>10 (dez) dias corridos</b>. Em caso de perda ou extravio, o mesmo ficar√° sujeito √†s normas administrativas da empresa.</p>
                </div>
                <div style="margin-top: 60px; display: grid; grid-template-columns: 1fr 1fr; gap: 40px; text-align: center;">
                    <div style="border-top: 1px solid #000; padding-top: 10px;">
                        <p style="font-size: 11px;">Assinatura do T√©cnico</p>
                        <p style="font-size: 10px; opacity: 0.7;">${lastCarga.tech}</p>
                    </div>
                    <div style="border-top: 1px solid #000; padding-top: 10px;">
                        <p style="font-size: 11px;">Respons√°vel Log√≠stica</p>
                        <p style="font-size: 10px; opacity: 0.7;">${lastCarga.op}</p>
                    </div>
                </div>
            </div>`;
        document.getElementById('print-area').innerHTML = html;
        window.print();
        document.getElementById('btn-print').style.display = 'none';
        document.getElementById('btn-confirm-carga').style.display = 'block';
    }

    // CONFER√äNCIA MALA - COMPROVANTE
    function imprimirConferencia() {
        const idx = document.getElementById('sel-view-mala').value;
        if(idx === '') return;
        const tec = db.techs[idx];
        const pendentes = tec.mala.filter(i => !conferidos.has(i.serial));
        
        const html = `
            <div style="color:#000; padding:40px; font-family: 'Segoe UI', Arial, sans-serif; max-width: 800px; margin: auto; background: #fff;">
                <div style="text-align:center; border-bottom: 4px solid #000; padding-bottom:10px; margin-bottom: 20px;">
                    <h1 style="margin:0; font-size: 24px;">üéí RELAT√ìRIO DE CONFER√äNCIA F√çSICA</h1>
                    <p style="margin:5px 0; font-weight: bold; text-transform: uppercase;">Unidade de Auditoria de Ativos</p>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px; background: #f9f9f9; padding:15px; border-radius: 8px; border: 1px solid #ddd;">
                    <div>
                        <p><b>T√âCNICO:</b> ${tec.name}</p>
                        <p><b>MATR√çCULA:</b> ${tec.login}</p>
                    </div>
                    <div style="text-align:right;">
                        <p><b>DATA/HORA:</b> ${now()}</p>
                        <p><b>OPERADOR:</b> ${currentUser}</p>
                    </div>
                </div>

                <h3 style="margin-top:25px; border-left: 5px solid #000; padding-left:10px;">LISTAGEM DE ATIVOS NA MALA</h3>
                <table style="width:100%; border-collapse: collapse; margin-top:10px;">
                    <thead>
                        <tr style="background:#000; color:#fff;">
                            <th style="padding:10px; border:1px solid #333; text-align:left;">SERIAL / MODELO</th>
                            <th style="padding:10px; border:1px solid #333; text-align:center;">STATUS AUDITORIA</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tec.mala.map(i => {
                            const isOk = conferidos.has(i.serial);
                            return `
                            <tr>
                                <td style="padding:8px; border:1px solid #ddd;"><b>${i.serial}</b><br><small>${i.modelo}</small></td>
                                <td style="padding:8px; border:1px solid #ddd; text-align:center; font-weight:bold; color: ${isOk ? 'green' : 'red'};">
                                    ${isOk ? '‚úÖ CONFERIDO' : '‚ùó AUSENTE'}
                                </td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                </table>

                ${pendentes.length > 0 ? `
                <div style="margin-top:25px; padding:20px; border: 2px solid #ee2e24; background: #fff5f5; border-radius: 8px;">
                    <h3 style="margin:0; color:#ee2e24;">‚ö†Ô∏è ALERTA DE PEND√äNCIA CR√çTICA</h3>
                    <p style="margin:10px 0; font-size:14px; text-align:justify;">
                        Aten√ß√£o! Foram identificados <b>${pendentes.length} item(ns)</b> ausentes nesta confer√™ncia f√≠sica. 
                        Conforme normas internas, o t√©cnico possui o prazo de <b>10 (dez) dias corridos</b> para localizar o material ou realizar o ressarcimento/presta√ß√£o de contas.
                    </p>
                </div>` : `
                <div style="margin-top:25px; padding:15px; border: 2px solid #00ff64; background: #f5fff5; border-radius: 8px; text-align:center;">
                    <h3 style="margin:0; color:#008000;">‚úÖ CONFER√äNCIA 100% CONCLU√çDA</h3>
                    <p>Todos os itens da carga digital foram localizados fisicamente na mala do t√©cnico.</p>
                </div>`}

                <div style="margin-top:50px; display:grid; grid-template-columns: 1fr 1fr; gap:50px; text-align:center;">
                    <div style="border-top: 1px solid #000; padding-top:10px;">
                        <p style="font-size:12px; margin:0;">Assinatura do T√©cnico</p>
                    </div>
                    <div style="border-top: 1px solid #000; padding-top:10px;">
                        <p style="font-size:12px; margin:0;">Respons√°vel Log√≠stica</p>
                    </div>
                </div>
            </div>`;
        document.getElementById('print-area').innerHTML = html;
        window.print();
    }

    // BACKUP COMPLETO
    function gerarBackupCompleto() {
        try {
            const wb = XLSX.utils.book_new();
            const dataAdm = db.master.filter(i => i.status === 'estoque').map(i => ({ "Serial": i.serial, "Modelo": i.modelo, "Data Entrada": i.dataHora, "Operador": i.operador }));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(dataAdm), "ESTOQUE_ADM");
            const dataTechs = []; db.techs.forEach(t => { t.mala.forEach(m => dataTechs.push({ "T√©cnico": t.name, "Login": t.login, "Serial": m.serial, "Modelo": m.modelo, "Carga": m.dataHora, "Operador": m.operador })); });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(dataTechs), "ESTOQUE_TECNICOS");
            const dataLogs = db.logs.map(l => ({ "Data": l.date, "Tipo": l.type, "T√©cnico": l.tech, "Qtde Itens": l.items ? l.items.length : 0, "Operador": l.op }));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(dataLogs), "HIST_MOVIMENTACOES");
            const dataCabos = []; if(db.cabosLogs) { db.cabosLogs.forEach(c => { c.items.forEach(it => { dataCabos.push({ "Data": c.date, "T√©cnico": c.techName, "Material": it.tipo, "Qtd": it.qtd, "Operador": c.op }); }); }); }
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(dataCabos), "LOG_CABOS");
            const dataBaixas = db.baixas ? db.baixas.map(b => ({ "Serial": b.serial, "Modelo": b.modelo, "Data Baixa": b.data, "Operador": b.op })) : [];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(dataBaixas), "BAIXAS_SISTEMA");
            XLSX.writeFile(wb, `BACKUP_TOTAL_CONSTRUCABLE_${new Date().toLocaleDateString().replace(/\//g, '-')}.xlsx`);
            notify("Backup completo gerado!");
        } catch (e) { notify("Erro no backup!", "error"); }
    }

    // EXPORTA√á√ïES ADM
    function exportExcelADM() {
        const data = db.master.filter(i => i.status === 'estoque').map(i => ({ "Serial": i.serial, "Modelo": i.modelo, "Data": i.dataHora, "Op": i.operador }));
        XLSX.writeFile(XLSX.utils.book_new(), "ESTOQUE_ADM.xlsx");
    }

    function exportExcelTechs() {
        const data = []; db.techs.forEach(t => t.mala.forEach(m => data.push({ "T√©cnico": t.name, "Serial": m.serial, "Modelo": m.modelo, "Data": m.dataHora })));
        XLSX.writeFile(XLSX.utils.book_new(), "ESTOQUE_TECNICOS.xlsx");
    }

    function exportExcelLogs() {
        const data = db.logs.map(l => ({ "Data": l.date, "Tipo": l.type, "Tecnico": l.tech, "Op": l.op }));
        XLSX.writeFile(XLSX.utils.book_new(), "HISTORICO_GERAL.xlsx");
    }

    // GEST√ÉO DE ENTRADA E MASTER
    function renderPendentes() {
        const list = document.getElementById('list-pendentes');
        if(!db.pendentes) db.pendentes = [];
        if(db.pendentes.length === 0) { list.innerHTML = "<p style='text-align:center; padding:20px; opacity:0.5;'>Nenhum item pendente.</p>"; return; }
        const grupos = {}; db.pendentes.forEach(p => { const data = p.dataHora.split(' ')[0]; if(!grupos[data]) grupos[data] = []; grupos[data].push(p); });
        let html = "";
        Object.keys(grupos).reverse().forEach(data => {
            html += `<div class="date-group">IMPORTA√á√ÉO: ${data} (${grupos[data].length})</div>`;
            grupos[data].forEach(item => { 
                html += `
                <div class="item-row">
                    <div style="display:flex; flex-direction:column;">
                        <span><b>${item.serial}</b> - ${item.modelo}</span>
                        <small style="opacity:0.6; font-size:0.7rem;">${item.dataHora} | OP: ${item.operador}</small>
                    </div>
                    <button class="btn-del" onclick="removerPendente('${item.serial}')">‚úñ</button>
                </div>`; 
            });
        });
        list.innerHTML = html;
    }

    function handleBipeEntrada(e) {
        if(e.key === 'Enter') {
            const sn = e.target.value.trim().toUpperCase(); if(!sn) return;
            const idx = db.pendentes.findIndex(p => p.serial === sn);
            if(idx !== -1) {
                const item = db.pendentes.splice(idx, 1)[0];
                item.status = 'estoque'; item.dataHora = now(); item.operador = currentUser;
                db.master.push(item); save(); renderPendentes(); notify(`Item ${sn} no estoque!`);
            } else { notify("N√£o encontrado nos pendentes!", "error"); }
            e.target.value = '';
        }
    }

    function processarEntradaLote() {
        const mod = document.getElementById('lote-modelo').value.trim().toUpperCase();
        const txt = document.getElementById('lote-entrada-txt').value.trim().toUpperCase();
        if(!mod || !txt) return notify("Preencha Modelo e Seriais!", "error");
        const sns = txt.split('\n').map(s => s.trim()).filter(s => s !== "");
        let count = 0;
        sns.forEach(sn => {
            if(!db.master.some(i => i.serial === sn) && !isSerialInAnyMala(sn)) {
                db.master.push({ serial: sn, modelo: mod, status: 'estoque', dataHora: now(), operador: currentUser });
                count++;
            }
        });
        document.getElementById('lote-entrada-txt').value = ''; updateAll();
        notify(`${count} itens adicionados ao ADM.`);
    }

    function limparPendentesGeral() { if(confirm("Limpar lista de pendentes?")) { db.pendentes = []; save(); renderPendentes(); } }
    function removerPendente(sn) { if(confirm("Remover dos pendentes?")) { db.pendentes = db.pendentes.filter(p => p.serial !== sn); save(); renderPendentes(); } }

    function addUser() {
        const n = document.getElementById('new-user-name').value.trim().toUpperCase();
        const p = document.getElementById('new-user-pass').value.trim();
        if(n && p) { db.users.push({name: n, pass: p}); updateAll(); renderUsersLists(); notify("Operador cadastrado!"); }
    }

    function isSerialInAnyMala(sn) { return db.techs.some(t => t.mala.some(m => m.serial === sn)); }

    function addManual() {
        const sn = document.getElementById('man-sn').value.trim().toUpperCase();
        const mod = document.getElementById('man-mod').value.trim().toUpperCase();
        if(!sn || !mod) return;
        if(isSerialInAnyMala(sn)) { notify("Serial com t√©cnico!", "error"); return; }
        if(db.master.some(i => i.serial === sn)) { notify("Serial j√° existe!", "error"); return; }
        db.master.push({ serial: sn, modelo: mod, status: 'estoque', dataHora: now(), operador: currentUser });
        updateAll(); notify("Item adicionado!");
    }

    function clearOnlyADM() { if(confirm("Limpar estoque ADM?")) { db.master = db.master.filter(i => i.status !== 'estoque'); updateAll(); notify("ADM limpo!"); } }

    function confirmarCarga() {
        const tIdx = document.getElementById('sel-tech-carga').value;
        if(tIdx === '' || queue.length === 0) return notify("Selecione t√©cnico!", "error");
        const tec = db.techs[tIdx]; const h = now();
        lastCarga = { tech: tec.name, login: tec.login, items: [...queue], date: h, op: currentUser };
        queue.forEach(q => {
            const mIdx = db.master.findIndex(i => i.serial === q.serial);
            if(mIdx !== -1){
                db.master[mIdx].status = 'tecnico'; db.master[mIdx].dataHora = h; db.master[mIdx].operador = currentUser;
                tec.mala.push({...db.master[mIdx]});
            }
        });
        db.logs.unshift({ ...lastCarga, type: 'SA√çDA' });
        queue = []; renderQueue(); updateAll();
        document.getElementById('btn-confirm-carga').style.display = 'none'; document.getElementById('btn-print').style.display = 'block';
    }

    function consultar(e) {
        if(e.key === 'Enter') {
            const sn = e.target.value.toUpperCase(); let r = "‚ùå N√ÉO ENCONTRADO";
            const noAdm = db.master.find(i => i.serial === sn && i.status === 'estoque');
            if(noAdm) r = `‚úÖ EM ADM | ${noAdm.dataHora} | OP: ${noAdm.operador || '---'}`;
            db.techs.forEach(t => { const noTec = t.mala.find(m => m.serial === sn); if(noTec) r = `üë§ COM: ${t.name} (${t.login}) | ${noTec.dataHora} | OP: ${noTec.operador || '---'}`; });
            document.getElementById('search-result').innerText = r;
        }
    }

    function updateAll() {
        save(); renderStats(); renderMaster(); renderLogs();
        const opts = '<option value="">Selecione...</option>' + db.techs.map((t,i) => `<option value="${i}">${t.name} (${t.login})</option>`).join('');
        ['sel-tech-carga', 'sel-view-mala', 'sel-tech-origem', 'sel-tech-cabos'].forEach(id => { if(document.getElementById(id)) document.getElementById(id).innerHTML = opts; });
        document.getElementById('sel-tech-destino').innerHTML = opts + '<option value="ADM">üè† ESTOQUE ADM</option>';
        renderUsersLists();
    }

    function renderUsersLists() {
        // Lista de Operadores
        document.getElementById('list-users').innerHTML = db.users.map((u, i) => `
            <div class="item-row">
                <span><b>${u.name}</b></span>
                ${u.name !== 'ADMIN' ? `<button class="btn-del" onclick="db.users.splice(${i},1); save(); renderUsersLists();">‚úñ</button>` : '<i>Padrao</i>'}
            </div>`).join('');
            
        // Lista de T√©cnicos na aba Gest√£o
        document.getElementById('list-techs-management').innerHTML = db.techs.map((t, i) => `
            <div class="item-row">
                <div style="display:flex; flex-direction:column;">
                    <span><b>${t.name}</b> <small>(${t.login})</small></span>
                    <small style="color:var(--claro-red)">${t.mala.length} ativos na mala</small>
                </div>
                <button class="btn-del" onclick="removerTecnico(${i})">REMOVER T√âCNICO ‚úñ</button>
            </div>`).join('');
    }

    function removerTecnico(idx) {
        if(db.techs[idx].mala.length > 0) return notify("ERRO: T√©cnico possui itens!", "error");
        if(confirm(`Excluir t√©cnico ${db.techs[idx].name}?`)) { db.techs.splice(idx, 1); updateAll(); notify("T√©cnico removido!"); }
    }

    function renderStats() { 
        const adm = db.master.filter(i => i.status === 'estoque').length; 
        let tech = 0; db.techs.forEach(t => tech += t.mala.length); 
        document.getElementById('stat-adm').innerText = adm; 
        document.getElementById('stat-tech').innerText = tech; 
        document.getElementById('stat-total').innerText = adm + tech; 
    }
    
    function getFamily(modelo) {
        const m = (modelo || "").toUpperCase();
        if(m.includes("3.0")) return "FAM√çLIA 3.0";
        if(m.includes("3.1")) return "FAM√çLIA 3.1";
        if(m.includes("FIBRA") || m.includes("ONU")) return "FIBRA √ìPTICA";
        return m.split(' ')[0] || "OUTROS";
    }

    function renderMaster() {
        const filter = document.getElementById('search-adm-list').value.toUpperCase();
        const items = db.master.filter(i => i.status === 'estoque' && (i.serial.includes(filter) || i.modelo.includes(filter)));
        const families = {};
        db.master.forEach(i => {
            const f = getFamily(i.modelo);
            if (!families[f]) families[f] = { adm: 0, tech: 0 };
            if (i.status === 'estoque') families[f].adm++;
            else { if(db.techs.some(t => t.mala.some(m => m.serial === i.serial))) families[f].tech++; }
        });
        document.getElementById('sum-master').innerHTML = Object.keys(families).sort().map(f => `
            <tr><td><b>${f}</b></td><td>${families[f].adm}</td><td>${families[f].tech}</td><td style="color:var(--claro-red)">${families[f].adm + families[f].tech}</td></tr>`).join('');
        document.getElementById('list-master').innerHTML = items.map(i => `
            <div class="item-row"><div style="display:flex; flex-direction:column;"><span><b>${i.serial}</b> - ${i.modelo}</span><small style="opacity:0.8; font-size:0.75rem; color: var(--claro-red);">üìÖ ${i.dataHora} | üë§ OP: ${i.operador || 'SISTEMA'}</small></div><button class="btn-del" onclick="db.master=db.master.filter(x=>x.serial!=='${i.serial}');updateAll();">‚úñ</button></div>`).join('');
    }

    function handleBipeCarga(e) {
        if(e.key === 'Enter') {
            const sn = e.target.value.trim().toUpperCase(); if(!sn) return;
            const item = db.master.find(i => i.serial === sn && i.status === 'estoque');
            if(item) { if(!queue.some(q => q.serial === sn)) { queue.push({...item}); renderQueue(); } }
            else notify("N√£o encontrado no ADM!", "error");
            e.target.value = '';
        }
    }
    function addLoteCarga() {
        const lines = document.getElementById('lote-carga').value.split('\n').map(s => s.trim().toUpperCase()).filter(s => s !== "");
        lines.forEach(sn => { const item = db.master.find(i => i.serial === sn && i.status === 'estoque'); if(item && !queue.some(q => q.serial === sn)) queue.push({...item}); });
        document.getElementById('lote-carga').value = ''; renderQueue();
    }
    function renderQueue() { 
        document.getElementById('queue-count').innerText = `(${queue.length})`;
        document.getElementById('list-queue').innerHTML = queue.map(i => `
            <div class="item-row"><div style="display:flex; flex-direction:column;"><span><b>${i.modelo}</b> | ${i.serial}</span><small style="font-size:0.6rem; opacity:0.6;">${i.dataHora}</small></div><button class="btn-del" onclick="queue=queue.filter(q=>q.serial!=='${i.serial}');renderQueue()">‚úñ</button></div>`).join(''); 
    }

    function marcarConferido(e) { if(e.key === 'Enter') { const sn = e.target.value.trim().toUpperCase(); conferidos.add(sn); e.target.value = ''; renderMalaCompleta(document.getElementById('sel-view-mala').value); } }
    function resetConferencia() { conferidos.clear(); renderMalaCompleta(document.getElementById('sel-view-mala').value); }
    
    function renderMalaCompleta(idx) {
        const container = document.getElementById('resumo-mala-container');
        if(idx === '') { container.style.display = 'none'; return; }
        container.style.display = 'block';
        const tec = db.techs[idx];
        const totalMala = tec.mala.length;
        const totalConferidos = tec.mala.filter(i => conferidos.has(i.serial)).length;
        const s = document.getElementById('mala-status-sinalizador');
        if(totalConferidos < totalMala) { s.className = "status-badge status-red"; s.innerHTML = `‚¨§ PENDENTE (${totalConferidos}/${totalMala})`; }
        else { s.className = "status-badge status-green"; s.innerHTML = `‚¨§ CONFERIDO (${totalConferidos})`; }
        const mFamilies = {};
        tec.mala.forEach(m => { const f = getFamily(m.modelo); mFamilies[f] = (mFamilies[f] || 0) + 1; });
        document.getElementById('sum-mala-tecnico').innerHTML = Object.keys(mFamilies).sort().map(f => `<tr><td>${f}</td><td>${mFamilies[f]}</td></tr>`).join('');
        document.getElementById('list-mala-items').innerHTML = tec.mala.map((i, subIdx) => `<div class="item-row ${conferidos.has(i.serial) ? 'checked' : ''}"><div style="display:flex; flex-direction:column;"><span><b>${i.serial}</b> - ${i.modelo}</span><small style="opacity:0.6; font-size:0.7rem;">üïí ${i.dataHora}</small></div><button class="btn-del" onclick="db.techs[${idx}].mala.splice(${subIdx},1);renderMalaCompleta(${idx});updateAll();">‚úñ</button></div>`).join('');
    }

    function renderMalaOrigem(idx) {
        if(idx === '') return;
        const tec = db.techs[idx];
        document.getElementById('list-mala-origem').innerHTML = tec.mala.map(m => `<div class="item-row"><span>${m.serial}</span><button class="btn-green" style="width:auto; padding:2px 10px;" onclick="addParaFilaTrans('${m.serial}')">‚ûú</button></div>`).join('');
    }
    function addParaFilaTrans(sn) {
        const oIdx = document.getElementById('sel-tech-origem').value;
        const item = db.techs[oIdx].mala.find(m => m.serial === sn);
        if(item && !transQueue.some(q => q.serial === sn)) { transQueue.push({...item}); renderTransQueue(); }
    }
    function addBipTrans(e) {
        if(e.key === 'Enter') {
            const sn = e.target.value.trim().toUpperCase(); if(!sn) return;
            const oIdx = document.getElementById('sel-tech-origem').value;
            if(oIdx === '') return notify("Selecione a origem!", "error");
            const item = db.techs[oIdx].mala.find(m => m.serial === sn);
            if(item) { if(!transQueue.some(q => q.serial === sn)) transQueue.push({...item}); }
            else notify("Serial n√£o est√° nesta mala!", "error");
            e.target.value = ''; renderTransQueue();
        }
    }
    function addLoteTrans() {
        const oIdx = document.getElementById('sel-tech-origem').value;
        const sns = document.getElementById('lote-trans').value.split('\n').map(s => s.trim().toUpperCase()).filter(s => s !== "");
        sns.forEach(sn => {
            const item = db.techs[oIdx].mala.find(m => m.serial === sn);
            if(item && !transQueue.some(q => q.serial === sn)) transQueue.push({...item});
        });
        document.getElementById('lote-trans').value = ''; renderTransQueue();
    }
    function renderTransQueue() {
        document.getElementById('trans-queue-count').innerText = `(${transQueue.length})`;
        document.getElementById('list-transfer-queue').innerHTML = transQueue.map((i, idx) => `<div class="item-row"><span>${i.serial}</span><button class="btn-del" onclick="transQueue.splice(${idx},1);renderTransQueue();">‚úñ</button></div>`).join('');
    }
    function executarMovimentacao() {
        const oIdx = document.getElementById('sel-tech-origem').value;
        const dIdx = document.getElementById('sel-tech-destino').value;
        if(oIdx === '' || dIdx === '' || transQueue.length === 0) return notify("Dados incompletos!", "error");
        transQueue.forEach(q => {
            db.techs[oIdx].mala = db.techs[oIdx].mala.filter(m => m.serial !== q.serial);
            const h = now();
            if(dIdx === 'ADM') {
                const mIdx = db.master.findIndex(i => i.serial === q.serial);
                if(mIdx !== -1) { db.master[mIdx].status = 'estoque'; db.master[mIdx].dataHora = h; db.master[mIdx].operador = currentUser; }
            } else {
                const mIdx = db.master.findIndex(i => i.serial === q.serial);
                if(mIdx !== -1) {
                    db.master[mIdx].status = 'tecnico'; db.master[mIdx].dataHora = h; db.master[mIdx].operador = currentUser;
                    db.techs[dIdx].mala.push({...db.master[mIdx]});
                }
            }
        });
        notify("Transfer√™ncia conclu√≠da!"); transQueue = []; renderTransQueue(); renderMalaOrigem(oIdx); updateAll();
    }

    document.getElementById('file-upload').addEventListener('change', function(e) {
        const reader = new FileReader(); reader.onload = function(e) {
            const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type: 'array'});
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            if(!db.pendentes) db.pendentes = [];
            json.forEach(row => { 
                const sn = (row['Endere√ßavel Principal'] || row['N√∫mero S√©rie'] || row['Serial'] || '').toString().trim().toUpperCase(); 
                const mod = (row['Modelo'] || row['Descri√ß√£o'] || '').toString().trim().toUpperCase(); 
                if(sn && mod && !db.master.some(i => i.serial === sn)) db.pendentes.push({ serial: sn, modelo: mod, status: 'pendente', dataHora: now(), operador: currentUser });
            });
            save(); updateAll(); notify("Importado para lista de espera.");
        }; reader.readAsArrayBuffer(e.target.files[0]);
    });

    function renderLogs() { document.getElementById('list-logs').innerHTML = db.logs.map(l => `<div class="item-row"><b>${l.tech}</b> <span>${l.items ? l.items.length : 0} itens</span> <small>${l.date}</small></div>`).join(''); }
    function initEmojis() { const c = document.getElementById('bg-canvas'); for(let i=0; i<8; i++) { const d = document.createElement('div'); d.className = 'emoji'; d.innerText = 'üì¶'; d.style.left = Math.random()*100 + 'vw'; d.style.animationDuration = (Math.random()*10 + 10) + 's'; c.appendChild(d); } }
    setInterval(() => { const clock = document.getElementById('clock'); if(clock) clock.innerText = new Date().toLocaleString(); }, 1000);
    
    function executarBaixa() {
        const sns = document.getElementById('txt-baixa').value.split('\n').map(s => s.trim().toUpperCase()).filter(s => s !== "");
        let removidos = 0; if(!db.baixas) db.baixas = [];
        sns.forEach(sn => { 
            const mIdx = db.master.findIndex(m => m.serial === sn);
            if(mIdx !== -1) { db.baixas.push({ serial: sn, modelo: db.master[mIdx].modelo, data: now(), op: currentUser }); db.master.splice(mIdx, 1); removidos++; }
            db.techs.forEach(t => { const subIdx = t.mala.findIndex(m => m.serial === sn); if(subIdx !== -1) { db.baixas.push({ serial: sn, modelo: t.mala[subIdx].modelo, data: now(), op: currentUser }); t.mala.splice(subIdx, 1); removidos++; } });
        });
        document.getElementById('txt-baixa').value = ''; updateAll(); notify(`${removidos} registros baixados.`);
    }

    function addTech() { 
        const n = document.getElementById('tech-name').value.trim().toUpperCase(); 
        const l = document.getElementById('tech-login').value.trim().toUpperCase(); 
        if(n && l) { 
            db.techs.push({ name: n, login: l, mala: [] }); 
            document.getElementById('tech-name').value = ''; document.getElementById('tech-login').value = '';
            updateAll(); notify("T√©cnico cadastrado!");
        } 
    }
</script>
</body>
</html>